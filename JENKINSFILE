pipeline {
    agent { label 'windows' }

     stages {
        stage('Get Code') {
            steps {
                // Limpiar el workspace
                cleanWs()
                // Obtener código del repo
                git 'https://github.com/dpc01cim/res-caso-practico-1.git'
                bat 'dir'
                echo WORKSPACE
                stash name:'code', includes:'**'
            }
        }
   
        stage('Unit') {
            steps {
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                    bat '''
                        set PYTHONPATH=.
                        coverage run --branch --source=app --omit=app\\__init__.py,app\\api.py -m pytest --junitxml=result-unit.xml test\\unit
                        coverage xml
                    '''
                    junit 'result-unit.xml'
                    stash name: 'coverage-data', includes: '.coverage'  // Stashea el archivo de datos de coverage
                    archiveArtifacts 'coverage.xml'  // Opcional, si quieres preservar el XML también
                }
            }
        }
               
        stage('Rest') {
            steps {
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                    bat '''
                        set FLASK_APP=app\\api.py
                        start flask run
                        start java -jar C:\\WireMock\\wiremock-standalone-3.13.2.jar --port 9090 --root-dir test\\wiremock
                        ping -n 10 127.0.0.1
                        python -m pytest --junitxml=result-rest.xml test\\rest
                    '''
                    junit 'result-rest.xml'
                }
            }
        }        

        stage ('Static') {
            steps {
                bat '''
                    flake8 --exit-zero --format=pylint app > flake8.out
                '''
                recordIssues tools: [
                    flake8(name:'flake8',
                    pattern:'flake8.out')],
                    qualityGates:[
                        [threshold: 8, type: 'TOTAL', unstable: true],
                        [threshold: 10, type: 'TOTAL', failure: true]]
            }
        }
       
        stage ('Security Test') {
            steps {
                bat '''
                   python -m bandit --exit-zero -r . -f custom -o bandit.out --msg-template "{abspath}:{line}: [{severity}] [{test_id}] {msg}"
                '''
               
                recordIssues tools: [
                    pyLint(name:'Bandit',
                    pattern:'bandit.out')],
                    qualityGates:[
                        [threshold: 2, type: 'TOTAL', unstable: true],
                        [threshold: 4, type: 'TOTAL', failure: true]]
            }
        }
       
        stage ('Cobertura') {
            steps {
                unstash 'coverage-data'  // Recupera el .coverage generado en Unit
                bat 'python -m coverage xml'  // Solo regenera el XML (es rápido, no re-ejecuta tests)
                recordCoverage(
                    tools: [[parser: 'COBERTURA', pattern: 'coverage.xml']],
                    qualityGates: [
                        [criticality: 'UNSTABLE', integerThreshold: 85, metric: 'LINE', threshold: 85.0],
                        [criticality: 'FAILURE', integerThreshold: 95, metric: 'LINE', threshold: 95.0],
                        [criticality: 'FAILURE', integerThreshold: 80, metric: 'BRANCH', threshold: 80.0],
                        [criticality: 'UNSTABLE', integerThreshold: 90, metric: 'BRANCH', threshold: 90.0]
                    ]
                )
            }
        }
       
        stage ('Performance') {
            steps {
                bat '''
                    set FLASK_APP=app\\api.py
                    start flask run
                    ping -n 4 127.0.0.1
                   
                    C:\\WireMock\\jmeter\\bin\\jmeter -n -t test\\jmeter\\flask.jmx -f -l flask.jtl
                '''
                perfReport sourceDataFiles: 'flask.jtl'
            }
        }
     }
}
